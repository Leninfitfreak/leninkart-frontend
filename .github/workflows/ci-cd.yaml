name: Deploy Frontend to GCP

on:
  push:
    branches:
      - main               # change to your default branch if different
  workflow_dispatch:       # allows manual trigger

env:
  SERVICE_NAME: frontend
  IMAGE_NAME: frontend
  GCP_PROJECT: leninkart-478305
  ARTIFACT_REPO: leninkart
  REGION: asia-south1
  INFRA_REPO: leninkart-infra
  INFRA_BRANCH: ${{ vars.INFRA_BRANCH || 'main' }}   # fallback to main if var not set

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------- Build & Push Docker Image -------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: '${{ secrets.GCP_SA_KEY }}@leninkart-478305.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build & Push Docker image
        run: |
          IMAGE_TAG=$(git rev-parse --short HEAD)
          FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          LATEST_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:latest"

          docker build -t $FULL_IMAGE -t $LATEST_IMAGE .
          docker push $FULL_IMAGE
          docker push $LATEST_IMAGE

          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "full_image=$FULL_IMAGE" >> $GITHUB_OUTPUT
        id: build

      # ------------------- Update Helm values in infra repo -------------------
      - name: Checkout Infra Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.actor }}/${{ env.INFRA_REPO }}
          token: ${{ secrets.INFRA_PAT }}
          path: infra-temp
          ref: ${{ env.INFRA_BRANCH }}

      - name: Install yq
        run: |
          sudo snap install yq --channel=v4/stable || true
          wget -q https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
          yq --version

      - name: Update image tag in helm/frontend/values.yaml
        run: |
          cd infra-temp

          VALUES_FILE="helm/frontend/values.yaml"
          
          if [ ! -f "$VALUES_FILE" ]; then
            echo "ERROR: $VALUES_FILE not found!"
            echo "Available files:"
            find . -name "*.yaml" | head -20
            exit 1
          fi

          yq eval '.image.tag = "${{ steps.build.outputs.image_tag }}"' -i "$VALUES_FILE"
          
          # Safety fallback in case yq fails on some systems
          sed -i "s|tag: .*|tag: \"${{ steps.build.outputs.image_tag }}\"|" "$VALUES_FILE"

          echo "Updated $VALUES_FILE with tag: ${{ steps.build.outputs.image_tag }}"

      - name: Commit & Push changes to infra repo
        run: |
          cd infra-temp
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"
          
          git add helm/frontend/values.yaml
          git commit -m "Deploy frontend ${{ steps.build.outputs.image_tag }} [skip ci]" || echo "No changes to commit"
          
          git push origin ${{ env.INFRA_BRANCH }}
          echo "Pushed new image tag to leninkart-infra â†’ ${{ env.INFRA_BRANCH }}"

      # ------------------- Success Message -------------------
      - name: Deployment Triggered
        run: |
          echo "Frontend successfully deployed!"
          echo "Image: ${{ steps.build.outputs.full_image }}"
          echo "Tag: ${{ steps.build.outputs.image_tag }}"
          echo "ArgoCD will sync automatically in a few seconds"
