name: Deploy Frontend to GCP (GitOps)

on:
  push:
    branches:
      - dev
      - staging
      - main
  workflow_dispatch:

env:
  SERVICE_NAME: frontend
  IMAGE_NAME: frontend
  GCP_PROJECT: leninkart-478305
  ARTIFACT_REPO: leninkart
  REGION: asia-south1
  INFRA_REPO: Leninfitfreak/leninkart-infra

jobs:
  build-and-promote:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      # ------------------- Checkout Service Repo -------------------
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------- Derive Environment from Branch -------------------
      - name: Set environment variables
        id: env
        run: |
          BRANCH=${GITHUB_REF##*/}

          if [ "$BRANCH" = "main" ]; then
            ENV=prod
            IMAGE_TAG="prod-${GITHUB_SHA::7}"
            INFRA_BRANCH=main
          elif [ "$BRANCH" = "staging" ]; then
            ENV=staging
            IMAGE_TAG="staging-${GITHUB_SHA::7}"
            INFRA_BRANCH=staging
          else
            ENV=dev
            IMAGE_TAG="dev-${GITHUB_SHA::7}"
            INFRA_BRANCH=dev
          fi

          echo "ENV=$ENV" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "INFRA_BRANCH=$INFRA_BRANCH" >> $GITHUB_ENV

      # ------------------- Authenticate to Google Cloud -------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECT }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: ${{ secrets.GCP_SA_KEY }}@leninkart-478305.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # ------------------- Build & Push Image -------------------
      - name: Build & Push Docker Image
        id: build
        run: |
          FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

          docker build -t $FULL_IMAGE .
          docker push $FULL_IMAGE

          echo "full_image=$FULL_IMAGE" >> $GITHUB_OUTPUT

      # ------------------- Checkout Infra Repo -------------------
      - name: Checkout Infra Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.INFRA_REPO }}
          token: ${{ secrets.INFRA_PAT }}
          ref: ${{ env.INFRA_BRANCH }}
          path: infra

      # ------------------- Install yq -------------------
      - name: Install yq
        run: |
          wget -q https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # ------------------- Update Helm values -------------------
      - name: Update Helm image tag
        run: |
          cd infra
          VALUES_FILE="helm/frontend/values.yaml"

          yq eval ".image.tag = \"${IMAGE_TAG}\"" -i "$VALUES_FILE"

          echo "Updated $VALUES_FILE with tag $IMAGE_TAG"

      # ------------------- Commit & Push Infra Changes -------------------
      - name: Commit & Push Infra Repo
        run: |
          cd infra
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"

          git add helm/frontend/values.yaml
          git commit -m "deploy(frontend): ${IMAGE_TAG} â†’ ${ENV}" || echo "No changes"
          git push origin $INFRA_BRANCH

      # ------------------- Success -------------------
      - name: Deployment Triggered
        run: |
          echo "Frontend deployment triggered via GitOps"
          echo "Environment: $ENV"
          echo "Image: ${{ steps.build.outputs.full_image }}"
          echo "Argo CD will sync automatically"
