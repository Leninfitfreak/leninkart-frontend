name: Deploy Frontend to GCP (GitOps)

on:
  push:
    branches:
      - dev
      - staging
      - main
  workflow_dispatch:

env:
  SERVICE_NAME: frontend
  IMAGE_NAME: frontend
  GCP_PROJECT_ID: leninkart-478305
  REGION: asia-south1
  ARTIFACT_REPO: leninkart

  # Infra repo (CD source of truth)
  INFRA_REPO: Leninfitfreak/leninkart-infra

jobs:
  build-and-promote:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write   # REQUIRED for Workload Identity
      packages: write

    steps:
      # ------------------------------------------------
      # 1. Checkout frontend repo
      # ------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------
      # 2. Decide environment from branch
      # ------------------------------------------------
      - name: Set environment variables
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [ "$BRANCH" = "main" ]; then
            ENV="prod"
            IMAGE_TAG="prod-${GITHUB_SHA::7}"
            INFRA_BRANCH="main"
          elif [ "$BRANCH" = "staging" ]; then
            ENV="staging"
            IMAGE_TAG="staging-${GITHUB_SHA::7}"
            INFRA_BRANCH="staging"
          else
            ENV="dev"
            IMAGE_TAG="dev-${GITHUB_SHA::7}"
            INFRA_BRANCH="dev"
          fi

          echo "ENV=$ENV" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "INFRA_BRANCH=$INFRA_BRANCH" >> $GITHUB_ENV

      # ------------------------------------------------
      # 3. Authenticate to Google Cloud (FIXED)
      # ------------------------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          # ðŸ”´ IMPORTANT: this MUST be PROJECT NUMBER, not project ID
          workload_identity_provider: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@leninkart-478305.iam.gserviceaccount.com

      # ------------------------------------------------
      # 4. Setup gcloud & Docker auth
      # ------------------------------------------------
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # ------------------------------------------------
      # 5. Build & Push Docker Image
      # ------------------------------------------------
      - name: Build & Push Docker Image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

          docker build -t $IMAGE .
          docker push $IMAGE

          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      # ------------------------------------------------
      # 6. Checkout Infra Repo (GitOps)
      # ------------------------------------------------
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.INFRA_REPO }}
          ref: ${{ env.INFRA_BRANCH }}
          token: ${{ secrets.INFRA_PAT }}
          path: infra

      # ------------------------------------------------
      # 7. Install yq
      # ------------------------------------------------
      - name: Install yq
        run: |
          wget -q https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # ------------------------------------------------
      # 8. Update Helm values.yaml
      # ------------------------------------------------
      - name: Update Helm image tag
        run: |
          cd infra
          VALUES_FILE="helm/frontend/values.yaml"

          yq eval ".image.tag = \"${IMAGE_TAG}\"" -i "$VALUES_FILE"

          echo "Updated $VALUES_FILE â†’ tag=${IMAGE_TAG}"

      # ------------------------------------------------
      # 9. Commit & Push Infra Changes
      # ------------------------------------------------
      - name: Commit & Push infra repo
        run: |
          cd infra
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"

          git add helm/frontend/values.yaml
          git commit -m "deploy(frontend): ${IMAGE_TAG} â†’ ${ENV}" || echo "No changes to commit"
          git push origin $INFRA_BRANCH

      # ------------------------------------------------
      # 10. Done
      # ------------------------------------------------
      - name: Deployment Triggered
        run: |
          echo "âœ… Frontend deployment triggered via GitOps"
          echo "Environment: $ENV"
          echo "Image: $IMAGE"
          echo "Argo CD will sync automatically"
